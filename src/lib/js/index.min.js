function select(e,t,a,s){let n=d3.select("#g-map");var c,i,o;if(e&&centered!==e){var l=t.centroid(e);c=l[0],i=l[1],o=4,centered=e}else c=a/2,i=s/2,o=1,centered=null;n.select("#counties").selectAll("path").classed("active",e=>centered&&arrayEqual(centered.coordinates[0],e.geometry.coordinates[0])),n.transition().duration(750).attr("transform","translate("+a/2+","+s/2+")scale("+o+")translate("+-c+","+-i+")").style("stroke-width",1.5/o+"px")}let centered;const weekData=[{},{},{},{},{},{},{},{},{},{},{},{},{},{}],dayDifference=(e,t)=>(e.getTime()-t.getTime())/864e5,cleanData=(e,t)=>{"New York City"==e.county&&(e.fips="NYC");let a=Math.floor(dayDifference(t,new Date(e.date)));if(a<14){let t="-",s="-";0==a&&weekData[13][e.fips]&&(t=e.cases-weekData[6][e.fips].cases),a<13&&weekData[a+1][e.fips]&&(s=e.cases-weekData[a+1][e.fips].cases),weekData[a][e.fips]={date:e.date,state:e.state,countyName:e.county,fips:e.fips,cases:e.cases,deaths:e.deaths,increase:s,weeklyIncrease:t}}},selectMapType=(e,t,a)=>{$("#map-title-form").on("change",async()=>{$(".loader").css("visibility","visible"),"casesPerCapitaPrev"==$("select").val()?await drawMap(e,t,a,"casesPerCapita",day=13):await drawMap(e,t,a,$("select").val()),centered=null})},mapData=async e=>{const t="https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv";let a=new Date((new Date).getTime()-1296e5);await d3.csv(t,e=>cleanData(e,a)),console.log(weekData[0]),0===Object.keys(weekData[0]).length&&(alert("Most recent data unavailable. Reverting to latest available data."),a=new Date((new Date).getTime()-1296e5),await d3.csv(t,e=>cleanData(e,a)));const s=await d3.csv("../../../assets/pop_est_2019.csv");console.log(weekData),selectMapType(weekData,e,s);let{WIDTH:n,HEIGHT:c,g:i,path:o,geometries:l}=await drawMap(weekData,e,s);handleSearch(weekData,e,n,c,i,o,l)},computeData=(e,t)=>({casesPerCapita:Math.floor(e.cases/t*1e3)/1e3,dailyIncrease100k:Math.floor(e.increase/t*1e5),weeklyIncreasePerCapita:Math.floor(e.weeklyIncrease/t*1e3)/1e3,deathsPerCase:Math.floor(e.deaths/e.cases*1e3)/1e3}),cleanPopulation=(e,t)=>{let a=t.filter(t=>e.fips==t.fips);return 0==a.length?NaN:a[0].population},configureNYCBoroughs=e=>e.map(e=>("36061"!=e.id&&"36047"!=e.id&&"36005"!=e.id&&"36081"!=e.id&&"36085"!=e.id||(e.id="NYC"),e)),countyConfig=e=>configureNYCBoroughs(e),mouseOver=(e,t)=>{$(document).width()>1050&&t.style("visibility","visible").html(`\n                <p class="subheading">${e.countyName}, ${e.state}</p>\n                <p class="tooltip-cases">Cases: ${parseInt(e.cases).toLocaleString()}</p>\n                <p class="tooltip-cases">Weekly Increase: <span class="red">+${parseInt(e.weeklyIncrease).toLocaleString()}</span></p>\n                <p class="tooltip-cases">Daily Increase: <span class="red">+${parseInt(e.increase).toLocaleString()}</span></p>\n                <p class="tooltip-cases">Cases Per Capita: ${e.casesPerCapita}</p>\n                <p class="tooltip-cases">Weekly Increase Per Capita: ${e.weeklyIncreasePerCapita}</span></p>\n                <p class="tooltip-cases">Daily Increase/100k: ${e.dailyIncrease100k}</span></p>\n            `)},mousemove=(e,t)=>{e.clientX>$(window).width()/2?t.style("left",`${e.clientX-200}px`).style("top",`${e.clientY+20}px`):t.style("left",`${e.clientX}px`).style("top",`${e.clientY+20}px`)},arrayEqual=(e,t)=>{if(e.length!==t.length)return!1;for(let a=0;a<e.length;a++)for(let s=0;s<2;s++)if(e[a][s]!==t[a][s])return!1;return!0},drawMap=async(e,t,a,s="casesPerCapita",n=0)=>{const c=940,i=640,o="white",l=.1,r="aquamarine",d={casesPerCapita:[0,.025,.05,.1,.125,.15],weeklyIncreasePerCapita:[0,.002,.005,.01,.015,.02],dailyIncrease100k:[0,10,70,160,210,260,310],deathsPerCase:[0,.002,.005,.02,.03,.04]},p=d[s];console.log(n,s),console.log(s);const u=["#F2DF91","#FFA83E","#FD6A0B","#D8382E","#AF1C43","#701547"];let f={};const y=d3.scaleLinear().domain(p).range(u),m=d3.select("svg").html("").attr("viewBox",`0 0 ${c} ${i}`),h=d3.zoom().scaleExtent([1,10]).translateExtent([[0,0],[c,i]]).on("zoom",e=>w.attr("transform",e.transform));m.call(h);const w=m.append("g").attr("viewBox","0 0 980 610").attr("id","g-map"),g=d3.geoPath(),D=await d3.json("https://d3js.org/us-10m.v1.json"),v=countyConfig(topojson.feature(D,D.objects.counties).features),k=topojson.feature(D,D.objects.states).features;let C,I=d3.select("#tooltip");return w.append("g").attr("id","counties").selectAll("path").data(v).enter().append("path").attr("d",g).each(function(t){if(C=e[n][t.id],C){f[C.fips]=t.geometry;let e=cleanPopulation(C,a),n=computeData(C,e);C.population=e,C.mainData=n[s],C=Object.assign(C,n),t.selection=C}}).attr("class","county").style("fill",function(t){let a=e[n][t.id];if(a){let e=t.selection.mainData;return e<=0?"#64c25f":y(e)}}).on("mouseover",function(){const e=d3.select(this).data()[0].selection;d3.select(this).style("stroke",r).style("stroke-width",2),mouseOver(e,I)}).on("mouseout",function(){I.style("visibility","hidden"),d3.select(this).classed("active")||d3.select(this).style("stroke",o).style("stroke-width",l)}).on("mousemove",function(e){mousemove(e,I)}).on("click",function(){let a=d3.select(this).data()[0],s=a.geometry,n=a.selection;select(s,g,c,i),info(n,e,t)}),w.append("g").attr("id","states").selectAll(g).data(k).enter().append("path").attr("d",g).attr("class","state"),$(".loader").css("visibility","hidden"),{WIDTH:c,HEIGHT:i,g:w,path:g,geometries:f}},main=async()=>{await fetch("/.netlify/functions/update");const e="https://raw.githubusercontent.com/COVID19StatePolicy/SocialDistancing/master/data/USstatesCov19distancingpolicy.csv",t=await d3.csv(e,function(e){if(""==e.DateEased&&""==e.DateEnded)return{state:e.StateName,dateEnacted:e.DateEnacted,dateEnded:e.DateEnded,dateEasedd:e.DateEased,notes:e.PolicyCodingNotes,source:e.PolicySource,maskLevel:e.PublicMaskLevel}});mapData(t)};main();